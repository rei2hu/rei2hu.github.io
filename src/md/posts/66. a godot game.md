# a godot game

<style type='text/css'>
  body {
    background-color: black;
    color: lightgray !important;
  }

  p {
    position: relative;
    z-index: 1;
  }

  #canvas {
    display: block;
    position: fixed !important;
    transform: scale(0.5);
    transform-origin: right;
  }

  #canvas:focus {
    outline: none
  }

  .godot {
    font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
    color: #e0e0e0;
    background-color: #3b3943;
    background-image: linear-gradient(to bottom, #403e48, #35333c);
    border: 1px solid #45434e;
    box-shadow: 0 0 1px 1px #2f2d35;
  }
</style>
<canvas id='canvas'>
HTML5 canvas appears to be unsupported in the current browser.<br />
Please try updating or use a different browser.
</canvas>
<div id='status'>
<div id='status-progress' style='display: none;' oncontextmenu='event.preventDefault();'>
<div id ='status-progress-inner'></div></div>
<div id='status-indeterminate' style='display: none;' oncontextmenu='event.preventDefault();'>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
</div>
<div id='status-notice' class='godot' style='display: none;'></div>
</div>

<script defer type='text/javascript' src='/blobs/66/Reimu Geimu.js'></script>
<script defer type='text/javascript' src='/blobs/66/bootstrap.js'></script>

Light font on pure black background time! This is mainly because I was tired of
trying to get the embedded game that *should* load in the back if you have
javascript enabled to work nicely. I hope your eyes don't get burned too badly
and the text isn't too hard to read... but at least it's an incentive to click
on the white bits in the background. If it overlaps. Which I hope it doesn't
because I added some custom css to avoid it. But it probably can.

I promised myself that I would make an actual video game this year, so I picked
up Godot. Well, here's a little sample game I did to learn a bit about the
engine... Except at the end I don't think I really learned much about the engine
itself as the game is too simple and doesn't leverage anything - like everything
in the game is generated through scripts and I hardly used any other part of the
engine. This is probably because I'm terrible at graphis, so I just write the
"backend" and make the graphics as simple as possible - case in point, my
previous "game" was made with just code and a graphics library instead of a game
engine.

Well I am more familiar with the scripting APIs at least. Overall I think Godot
is much nicer to work with compared to Unity as it's much much much much more
lightweight and it covers the necessary functionality that I'm looking for... so
far. Perhaps the lightweightedness can also be attributed to my laptop now
having a SSD instead of a HDD.

Another cool thing is that Godot can has HTML5 as a target and outputs wasm,
which is how I got the game on to this page. It only required exporting it
through Godot and then mucking around with the created files.

The first thing I wanted to do was extract the relevant parts of the html file
which you can find in this page's source once you break through the minimization.
Afterwords, I moved the generated script of the page into its own script ie
`bootstrap.js`. This was definitely not needed but I didn't want the script in
here. I then moved all of the other generated files into my `blobs` directory as
that's where I keep post specific items. This caused a small issue because the
scripts assume everything is in the same directory. I worked around this by
modiyfing a line in the `bootstrap.js` file to update file paths:

```js
const GODOT_CONFIG = {
    "args": [],
    "canvasResizePolicy": 2,
    "executable": "/blobs/66/Reimu Geimu",
    "experimentalVK": false,
    "fileSizes":{
        "/blobs/66/Reimu Geimu.pck": 34000,
        "/blobs/66/Reimu Geimu.wasm": 17862218
    },
    "focusCanvas":true,"gdnativeLibs": []
};
```

Perhaps these should be strictly file names but adding the path seemed to be a
safe bet. There are other places you could edit the
[non-bootstrap.js](/blobs/66/Reimu%20Geimu.js) file, around `loadPromise` or
`loadFetch` or even `Engine.load` but after a few minutes of sprinting through
the code I think the configuration was the best bet for this scenario.

After working through that, I came across a new error: `CompileError: wasm
validation error: at offset 4: failed to match magic number`. This was
interesting, as it suggests the wasm payload was somehow getting messed up. Based
on some tests, I was able to load the game with the original generated html file
but not the html that gets generated from posts like these - so something in the
html files must be affecting it, specifically one of the scripts (because what
else could). Some more testing later I figured out it was the inclusion of the
[tikz](/scripts/tikz.js) bootloader that was causing this somehow. TLDR,
somewhere in that script either `ReadableStream` or
`ReadableStreamDefaultController` is being overwritten so that the controller
provided to the `start` callback does not have the same functionality as
`ReadableStreamDefaultController`. Specifically, these few lines start causing
some kind of issue.

<!-- markdownlint-disable line-length -->
```js
function getTrackedResponse(response, load_status) {
    // ...
    return new Response(new ReadableStream({
        start: function (controller) {
            onloadprogress(reader, controller).then(function () {
                // controller here is possibly messed up
                console.log(controller);
                controller.close();
            });
        },
    }), { headers: response.headers });
}

// Object { _controlledReadableStream: {…}, _underlyingSource: {…}, _queue: (1) […], _started: true, _closeRequested: true, _pullAgain: false, _pulling: false, _strategySize: undefined, _strategyHWM: 1 }
// ReadableStreamDefaultController { desiredSize: 0 }
```
<!-- markdownlint-enable line-length -->

Calling `arrayBuffer()` on the above response would return either the entire
wasm payload or 15 bytes in the broken case. Fortunately I was able to entirely
sidestep this function, though I guess it may cause some inefficiencies around
loading since that's what it looks like the function is for, or maybe it's just
used for updating the initial loading bar. I probably could find out some more
details if I wanted to dig through `tikz.js` - I love webpack, not.

Cleaning that up was the last step in getting it to work, and afterwards I
slapped the styles around to make the game display somewhat nicely on this page.
Specifically removing all styles around the loading bar and scaling the canvas
element which contains the game itself.

Is it too late for the tutorial? Try to flip all tiles to the same color while
minimizing the number of clicks. There's a counter in the top left which uses
white text (genius!) that keeps track of your clicks. The game is endless and
randomly generated apart from the first set of tiles which is supposed to read
"Reimu Geimu" which was a suggested name that I did not come up with.

On a somewhat related note, nice to use wasm yet again.
